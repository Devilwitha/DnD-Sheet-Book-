name: Build Raspberry Pi Image with Autostart

on:
  workflow_dispatch:

jobs:
  build-pi-image:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-utils kpartx

      - name: Download Raspberry Pi OS Lite image
        run: |
          wget -O rpi.img.xz https://downloads.raspberrypi.org/raspios_lite_armhf_latest
          xz -d rpi.img.xz

      - name: Mount image and copy project with autostart
        run: |
          set -e
          sudo losetup -Pf rpi.img
          sudo partprobe /dev/loop0
          sudo kpartx -av rpi.img
          sleep 2
          if [ ! -e /dev/mapper/loop0p2 ]; then
            echo "Partition /dev/mapper/loop0p2 not found!"
            sudo kpartx -dv rpi.img
            sudo losetup -d /dev/loop0
            exit 1
          fi
          MOUNTDIR=$(mktemp -d)
          sudo mount /dev/mapper/loop0p2 $MOUNTDIR
          sudo mkdir -p $MOUNTDIR/home/pi/DnD-Sheet-Book-
          sudo cp -r . $MOUNTDIR/home/pi/DnD-Sheet-Book-
          sudo chown -R 1000:1000 $MOUNTDIR/home/pi/DnD-Sheet-Book-
          sudo tee $MOUNTDIR/home/pi/start_dnd_app.sh > /dev/null <<'EOF'
          #!/bin/bash
          cd /home/pi/DnD-Sheet-Book-
          pip3 install -r requirements.txt
          python3 main.py
          EOF
          sudo chmod +x $MOUNTDIR/home/pi/start_dnd_app.sh
          if ! grep -q start_dnd_app.sh $MOUNTDIR/etc/rc.local; then
            sudo sed -i '/^exit 0/i su - pi -c "/home/pi/start_dnd_app.sh &"' $MOUNTDIR/etc/rc.local
          fi
          sudo umount $MOUNTDIR
          sudo kpartx -dv rpi.img
          sudo losetup -d /dev/loop0

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: raspberry-pi-image-autostart
          path: rpi.img
